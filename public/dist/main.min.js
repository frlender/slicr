var Lich=angular.module("Lich",["ngTagsInput","ngRoute","ui.bootstrap"]),baseURL=window.location.origin+window.location.pathname;Lich.config(["$routeProvider",function(a){a.when("/search",{templateUrl:"search.html",controller:"search"}).when("/search/:tags",{templateUrl:"search.html",controller:"search"}).when("/checkout",{templateUrl:"checkout.html",controller:"checkout"}).when("/scatter/:typeId",{templateUrl:"scatter.html",controller:"scatter"}).otherwise({redirectTo:"/search"})}]),$.get("test/pca.json",function(a){var b=["#7cb5ec","#434348","#90ed7d","#f7a35c","#8085e9","#f15c80","#e4d354","#8085e8","#8d4653","#91e8e1"],c={perturbation:{count:0,map:{}},cell:{count:0,map:{}},time:{count:0,map:{}}},d=[];a.items.forEach(function(e,f){e.viz={},e.viz.colors={},e.pert_id in c.perturbation.map?e.viz.colors.perturbation=c.perturbation.map[e.pert_id]:(e.viz.colors.perturbation=b[c.perturbation.count],c.perturbation.count++),e.cell in c.cell.map?e.viz.colors.cell=c.cell.map[e.pert_id]:(e.viz.colors.cell=b[c.cell.count],c.cell.count++),e.time in c.time.map?e.viz.colors.time=c.time.map[e.pert_id]:(e.viz.colors.time=b[c.time.count],c.time.count++),e.viz.data={x:a.scores[f][0],y:a.scores[f][1],z:a.scores[f][2],name:[e.pert,e.cell,e.time].join(", "),color:e.viz.colors.perturbation},d.push(e.viz.data)});var e=new Highcharts.Chart({chart:{renderTo:"container",margin:100,type:"scatter",options3d:{enabled:!0,alpha:10,beta:30,depth:250,viewDistance:5,frame:{}}},title:{text:"Draggable box"},subtitle:{text:"Click and drag the plot area to rotate in space"},tooltip:{formatter:function(){return this.point.name}},plotOptions:{scatter:{width:1,height:1,depth:1}},yAxis:{min:-1,max:1,title:null},xAxis:{min:-1,max:1,gridLineWidth:1},zAxis:{min:-1,max:1,showFirstLabel:!1},legend:{enabled:!1},series:[{name:"Reading",colorByPoint:!0,data:d}]});$(e.container).bind("mousedown.hc touchstart.hc",function(a){a=e.pointer.normalize(a);var b,c,d=a.pageX,f=a.pageY,g=e.options.chart.options3d.alpha,h=e.options.chart.options3d.beta,i=5;$(document).bind({"mousemove.hc touchdrag.hc":function(a){c=h+(d-a.pageX)/i,e.options.chart.options3d.beta=c,b=g+(a.pageY-f)/i,e.options.chart.options3d.alpha=b,e.redraw(!1)},"mouseup touchend":function(){$(document).unbind(".hc")}})})}),Lich.controller("index",["$scope","$http","$location","$http","registry",function(a,b,c,b,d){a.tags=[];var e=["level34","level5"];a.types=e.map(function(a){var b=d[a];return b.id=a,b}),a.selectedCount=0,a.types.forEach(function(b,d){b.selectedItems={},b.initFrom=0,b.initSize=15,b.from=b.initFrom,b.size=b.initSize,b.checkoutSelectedCount=0,a.$watch(function(a){return a.types[d].selectedItems},function(b,d){a.selectedCount+=Object.keys(b).length-Object.keys(d).length,0==a.selectedCount&&"/checkout"==c.path()&&c.path("/search")},!0),b.toggleSelected=function(a){a.__selected?b.selectedItems[a[b.itemIdKey]]=a:delete b.selectedItems[a[b.itemIdKey]]}}),a.toPreviousView=function(){var a=c.path();"/checkout"==a?c.path("/search"):S(a).contains("/scatter")&&c.path("/checkout")},a.loadTags=function(a){return b.get(baseURL+"tags?typed="+a)},a.isNotSearchView=function(){var a=c.path();return!S(a).contains("/search")},a.singleSearch=function(c){var d=a.tags.map(function(a){return a.text}).join(" ");b.get(baseURL+"search?typed="+d+"&from="+c.from+"&size="+c.size+"&type="+c.id).then(function(b){b.data.hits.forEach(function(a){a[c.itemIdKey]in c.selectedItems?a.__selected=!0:a.__selected=!1}),c.items=b.data.hits,a.count=b.data.count})},a.search=function(){a.types.forEach(function(b){b.from=b.initFrom,b.size=b.initSize,a.singleSearch(b)})},a.previous=function(b){b.from>0&&(b.from=b.from-b.size,a.singleSearch(b))},a.next=function(b){b.from=b.from+b.size,a.singleSearch(b)},a.isEmptyObj=function(a){for(var b in a)return!1;return!0},a.hasSelected=function(b){var c=b.selectedItems;return!a.isEmptyObj(c)},a.remove=function(a,b){var c=b[a.itemIdKey];a.selectedItems[c].__selected=!1,a.selectedItems[c].__checkoutSelected=!1,b.__selected=!1,delete a.selectedItems[c]}}]).controller("search",["$scope","$routeParams",function(a,b){a.types.forEach(function(a){a.items&&a.items.forEach(function(b){b[a.itemIdKey]in a.selectedItems?b.__selected=!0:b.__selected=!1})}),a.isEmptyObj(b)||void 0!=a.firstParamSearch||(a.$parent.tags=b.tags.split(",").map(function(a){return{text:a}}),a.search(),a.firstParamSearch="searched"),a.selectItems=function(b){var c=function(a){a.__selected=!0,b.selectedItems[a[b.itemIdKey]]=a};switch(b.searchView.select.option){case"all":b.items.forEach(function(a){c(a)});break;case"none":b.items.forEach(function(c){c.__selected&&a.remove(b,c)});break;case"reverse":b.items.forEach(function(d){d.__selected?a.remove(b,d):c(d)});break;case"significant":b.items.filter(b.highlight).forEach(function(a){c(a)})}}}]).controller("checkout",["$scope","$http","download","$window","$location","enrichr",function(a,b,c,d,e,f){d.onclick=function(b){!$(b.target).hasClass("icon-popover")&&a.itemOfActivePopover&&(a.itemOfActivePopover.__popover=!1,a.$digest())},a.enrichr=f,a.templateURL={popover:"popover.html",upGenes:"upGenes.html",dnGenes:"dnGenes.html"},a.types.forEach(function(a){"remove"in a||(a.remove=function(b){a.selectedItems[b[a.itemIdKey]].__selected=void 0,a.selectedItems[b[a.itemIdKey]].__checkoutSelected=void 0,delete a.selectedItems[b[a.itemIdKey]]})}),a.download=function(){var b=[];a.types.forEach(function(c){if(a.hasSelected(c)){var d={id:c.id};d.selectedIds=Object.keys(c.selectedItems),b.push(d)}}),c(b)},a.openDEGs=function(a,c,d){void 0==c.upGenes?b.get(baseURL+"DEGs?id="+c[a.itemIdKey]+"&level="+a.id).then(function(a){c.upGenes=a.data.upGenes,c.dnGenes=a.data.dnGenes,c[d]=!0}):c[d]=!0},a.openPopover=function(b,c){a.itemOfActivePopover&&a.itemOfActivePopover[b.itemIdKey]!=c[b.itemIdKey]&&(a.itemOfActivePopover.__popover=!1),c.__popover?c.__popover=!1:(c.__popover=!0,a.itemOfActivePopover=c)},a.buildDownloadURL=function(a,b){return baseURL+"downloadSingle?id="+b[a.itemIdKey]+"&level="+a.id},a.getLinkToL1000CDS2=function(a,c){b.get(baseURL+"l1000cds2?id="+c[a.itemIdKey]+"&level="+a.id).then(function(a){window.open(a.data)})},a.includeThisIcon=function(a,b){return a.checkoutView.popoverIcons.indexOf(b)>-1?!0:!1},a.selectItems=function(a){switch(a.checkoutView.select.option){case"all":for(var b in a.selectedItems)a.selectedItems[b].__checkoutSelected=!0;a.checkoutSelectedCount=Object.keys(a.selectedItems).length;break;case"none":for(var b in a.selectedItems)a.selectedItems[b].__checkoutSelected=!1;a.checkoutSelectedCount=0;break;case"reverse":var c=0;for(var b in a.selectedItems)a.selectedItems[b].__checkoutSelected=!a.selectedItems[b].__checkoutSelected,a.selectedItems[b].__checkoutSelected&&(c+=1);a.checkoutSelectedCount=c;break;case"significant":var c=0;for(var b in a.selectedItems)a.highlight(a.selectedItems[b])&&(a.selectedItems[b].__checkoutSelected=!0),a.selectedItems[b].__checkoutSelected&&(c+=1);a.checkoutSelectedCount=c}},a.removeItems=function(b){switch(b.checkoutView.remove.option){case"all":for(var c in b.selectedItems)a.remove(b,b.selectedItems[c]);b.checkoutSelectedCount=0;break;case"selected":for(var c in b.selectedItems)b.selectedItems[c].__checkoutSelected&&a.remove(b,b.selectedItems[c]);b.checkoutSelectedCount=0}},a.countCheckoutSelected=function(a){var b=0;for(var c in a.selectedItems)a.selectedItems[c].__checkoutSelected&&(b+=1);a.checkoutSelectedCount=b},a.visualizePCA=function(a){e.path("/scatter/"+a.id)}}]).controller("scatter",["$scope","$http","$routeParams","$location",function(a,b,c,d){var e=a.types.filter(function(a){return a.id==c.typeId})[0];if(e.checkoutSelectedCount<3)d.path("/checkout");else{a.scatterInput={items:[],plotName:e.scatterView.route.toUpperCase()};var f=[];for(var g in e.selectedItems){var h=e.selectedItems[g];h.__checkoutSelected&&(f.push(h[e.itemIdKey]),a.scatterInput.items.push(h))}var i={level:e.id,IDs:f};a.colorParam="perturbation",b.post(baseURL+e.scatterView.route,i).then(function(b){a.scatterInput.scores=b.data})}}]),Lich.directive("scatter3d",[function(){return{link:function(a,b,c){a.$watch("scatterInput.scores",function(b){if(b&&b.length>0){var c=a.scatterInput,d=["#7cb5ec","#434348","#90ed7d","#f7a35c","#8085e9","#f15c80","#e4d354","#8085e8","#8d4653","#91e8e1"],e={perturbation:{count:0,map:{}},cell:{count:0,map:{}},time:{count:0,map:{}}},f={},g={},h=["x","y","z"],i=[];c.items.forEach(function(a,b){a.viz={},a.viz.colors={},a.pert_id in e.perturbation.map?a.viz.colors.perturbation=e.perturbation.map[a.pert_id]:(a.viz.colors.perturbation=d[e.perturbation.count],e.perturbation.map[a.pert_id]=d[e.perturbation.count],e.perturbation.count++),a.cell in e.cell.map?a.viz.colors.cell=e.cell.map[a.cell]:(a.viz.colors.cell=d[e.cell.count],e.cell.map[a.cell]=d[e.cell.count],e.cell.count++),a.time in e.time.map?a.viz.colors.time=e.time.map[a.time]:(a.viz.colors.time=d[e.time.count],e.time.map[a.time]=d[e.time.count],e.time.count++),a.viz.data={x:c.scores[b][0],y:c.scores[b][1],z:c.scores[b][2],name:[a.pert,a.cell,a.time].join(", "),color:a.viz.colors.perturbation},i.push(a.viz.data),h.forEach(function(b){b in f?f[b]=a.viz.data[b]<f[b]?a.viz.data[b]:f[b]:f[b]=a.viz.data[b],b in g?g[b]=a.viz.data[b]>g[b]?a.viz.data[b]:g[b]:g[b]=a.viz.data[b]})});var j=new Highcharts.Chart({chart:{renderTo:"container",margin:100,width:600,type:"scatter",options3d:{enabled:!0,alpha:10,beta:30,depth:250,viewDistance:5,frame:{}}},title:{text:c.plotName+" plot"},subtitle:{text:""},tooltip:{formatter:function(){return this.point.name}},plotOptions:{scatter:{width:1,height:1,depth:1}},yAxis:{min:f.y,max:g.y,title:null},xAxis:{min:f.x,max:g.x,gridLineWidth:1},zAxis:{min:f.z,max:g.z,showFirstLabel:!1},legend:{enabled:!1},series:[{name:"Reading",colorByPoint:!0,data:i}]});$(j.container).bind("mousedown.hc touchstart.hc",function(a){a=j.pointer.normalize(a);var b,c,d=a.pageX,e=a.pageY,f=j.options.chart.options3d.alpha,g=j.options.chart.options3d.beta,h=5;$(document).bind({"mousemove.hc touchdrag.hc":function(a){c=g+(d-a.pageX)/h,j.options.chart.options3d.beta=c,b=f+(a.pageY-e)/h,j.options.chart.options3d.alpha=b,j.redraw(!1)},"mouseup touchend":function(){$(document).unbind(".hc")}})}),a.$watch("colorParam",function(a,b){a!=b&&(i.forEach(function(b,d){b.color=c.items[d].viz.colors[a]}),j.series[0].setData(i,!0),j.series[0].data.forEach(function(b,d){b.graphic.attr({fill:c.items[d].viz.colors[a]})}))})}})}}}]),Lich.value("registry",{level34:{itemIdKey:"cid",name:"Level 3",highlight:function(a){return!1},getName:function(a){return[a.batch,a.pert,a.dose].join(", ")},searchView:{select:{init:"all",options:["all","reverse","none"]}},checkoutView:{select:{init:"all",options:["all","reverse","none"]},remove:{init:"selected",options:["selected","all"]},popoverIcons:["download"],popoverWidth:22},scatterView:{route:"pca"}},level5:{itemIdKey:"sig_id",name:"Level 5 (CD)",highlight:function(a){return a.pvalue<=.1},getName:function(a){return[a.batch,a.pert,a.dose].join(", ")},searchView:{select:{init:"significant",options:["significant","all","reverse","none"]}},checkoutView:{select:{init:"significant",options:["significant","all","reverse","none"]},remove:{init:"selected",options:["selected","all"]},popoverIcons:["upGenes","dnGenes","download","l1000cds2"],popoverWidth:82},scatterView:{route:"mds"}}}),Lich.factory("download",function(){return function(a){var b=document.createElement("form");b.setAttribute("method","post"),b.setAttribute("action",baseURL+"download");var c=document.createElement("input");c.setAttribute("type","hidden"),c.setAttribute("name","data"),c.setAttribute("value",JSON.stringify(a)),b.appendChild(c),document.body.appendChild(b),b.submit(),document.body.removeChild(b)}}),Lich.factory("enrichr",function(){return function(a,b){var c={description:b,list:a.join("\n"),popup:!0};"undefined"==typeof c.description&&(c.description=defaultOptions.description),"undefined"==typeof c.popup&&(c.popup=defaultOptions.popup),"undefined"==typeof c.list&&alert("No genes defined.");var d=document.createElement("form");d.setAttribute("method","post"),d.setAttribute("action","http://amp.pharm.mssm.edu/Enrichr/enrich"),c.popup&&d.setAttribute("target","_blank"),d.setAttribute("enctype","multipart/form-data");var e=document.createElement("input");e.setAttribute("type","hidden"),e.setAttribute("name","list"),e.setAttribute("value",c.list),d.appendChild(e);var f=document.createElement("input");f.setAttribute("type","hidden"),f.setAttribute("name","description"),f.setAttribute("value",c.description),d.appendChild(f),document.body.appendChild(d),d.submit(),document.body.removeChild(d)}});